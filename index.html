<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resident Data Management System</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <script src="https://unpkg.com/gridjs/dist/gridjs.umd.js"></script>
    <link href="https://unpkg.com/gridjs/dist/theme/mermaid.min.css" rel="stylesheet" />
    
    <style>
        :root {
            --primary: #1a73e8;
            --success: #34a853;
            --header-bg: #2c3e50;
            --row-4-bg: rgb(252, 213, 180);
            --bg: #f1f3f4;
        }

        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--bg); margin: 0; padding: 20px; }
        
        /* Layout Containers */
        .dashboard-container { max-width: 1600px; margin: 0 auto; background: white; border-radius: 12px; box-shadow: 0 4px 25px rgba(0,0,0,0.1); overflow: hidden; }
        
        .top-bar { display: flex; justify-content: space-between; align-items: center; padding: 20px 30px; background: white; border-bottom: 1px solid #e0e0e0; }
        
        .upload-zone { border: 2px dashed var(--primary); background: #f8fbff; padding: 20px; border-radius: 8px; cursor: pointer; text-align: center; flex-grow: 1; margin: 0 20px; }

        /* Table Optimization */
        #table-wrapper { padding: 20px; }
        
        /* GridJS Custom Overrides for readability */
        .gridjs-table { font-size: 12px !important; white-space: nowrap; }
        .gridjs-td { padding: 8px 12px !important; border: 1px solid #eee !important; }
        .gridjs-th { background-color: #f8f9fa !important; padding: 10px !important; font-weight: bold !important; }
        
        /* Freezing first columns logic */
        .gridjs-tr td:nth-child(1), .gridjs-tr th:nth-child(1),
        .gridjs-tr td:nth-child(2), .gridjs-tr th:nth-child(2) {
            position: sticky; left: 0; background: white; z-index: 2; border-right: 2px solid var(--primary) !important;
        }
        .gridjs-tr th:nth-child(1), .gridjs-tr th:nth-child(2) { background: #f8f9fa; z-index: 3; }

        .btn { padding: 12px 20px; border-radius: 6px; font-weight: 600; cursor: pointer; border: none; transition: 0.2s; }
        .btn-download { background: var(--success); color: white; }
        .btn-download:disabled { background: #ccc; cursor: not-allowed; }

        .stat-badge { background: #e8f0fe; color: var(--primary); padding: 5px 12px; border-radius: 20px; font-weight: bold; }
    </style>
</head>
<body>

<div class="dashboard-container">
    <div class="top-bar">
        <div>
            <h2 style="margin:0">Data Explorer</h2>
            <small id="row-count">No data loaded</small>
        </div>

        <div class="upload-zone" onclick="document.getElementById('fileInput').click()">
            <span id="file-label">Click to upload (Statistics File)</span>
            <input type="file" id="fileInput" accept=".xlsx, .csv" style="display:none">
        </div>

        <button id="downloadBtn" class="btn btn-download" disabled>Download Excel (Calibri 10)</button>
    </div>

    <div id="table-wrapper">
        <div id="grid-mount"></div>
    </div>
</div>

<script>
    let rawData = [];
    const headers = ["‚Ññ", "Rez_NAME", "Reg_office", "1.1 Uslugi_name", "1.2 Summa_tis.sum", "1.3 OKED", "1.4 Uslugi_name", "2.1 Strana_exp", "2.2 Exp_doll", "2.3 Exp_tis.sum", "2.4 OKED", "3.1 Name_Gov", "3.2 Project_name", "3.3 Summa_tis.sum", "4.1 Other", "4.2 Other_tis.sum", "5.1 admin_count", "5.2 admin_salary", "6.1 admin_foreign_count", "6.2 admin_foreign_salary", "7.1 core_count", "7.2 core_salary", "8.1 core_foreign_count", "8.2 core_foreign_salary", "9.1 core_contract_count", "9.2 core_contract_salary", "10.1 dev_count", "10.2 dev_salary", "11.1 dev_foreign_count", "11.2 dev_foreign_salary", "12.1 dev_contract_count", "12.2 dev_contract_salary", "13.1 info_count", "13.2 info_salary", "14.1 info_foreign_count", "14.2 info_foreign_salary", "15.1 info_contract_count", "15.2 info_contract_salary", "16.1 teachers_count", "16.2 teachers_salary", "17.1 cert_teachers_count", "17.2 cert_teachers_salary", "18.1 teachers_foreign_count", "18.2 teachers_foreign_salary", "19.1 teachers_contract_count", "19.2 teachers_contract_salary", "20.1 inv", "20.2 inv_own_funds", "20.3 inv_other_sources", "21.1 Inv_direc", "21.2 inv_direc_startups", "21.3 inv_property_equipment", "21.4 inv_training_it", "21.5 inv_foreign_clients", "21.6 inv_new_software"];

    document.getElementById('fileInput').addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if(!file) return;

        document.getElementById('file-label').innerText = file.name;
        const workbook = new ExcelJS.Workbook();
        const reader = new FileReader();

        reader.onload = async (ev) => {
            if (file.name.endsWith('.csv')) await workbook.csv.readBinaryValue(ev.target.result);
            else await workbook.xlsx.load(ev.target.result);

            const sheet = workbook.worksheets[0];
            rawData = [];
            
            sheet.eachRow((row, rowNum) => {
                if (rowNum <= 4) return;
                let values = [];
                for(let i=1; i<=55; i++) {
                    const v = row.getCell(i).value;
                    values.push(v === null ? "" : v.toString());
                }
                rawData.push(values);
            });

            document.getElementById('row-count').innerHTML = `<span class="stat-badge">${rawData.length} Residents Loaded</span>`;
            renderGrid();
            document.getElementById('downloadBtn').disabled = false;
        };
        reader.readAsArrayBuffer(file);
    });

    function renderGrid() {
        new gridjs.Grid({
            columns: headers.map(h => ({ name: h, width: '180px' })),
            data: rawData,
            search: true,
            sort: true,
            pagination: { limit: 12 },
            fixedHeader: true,
            height: '600px',
            resizable: true,
            language: { 'search': { 'placeholder': 'üîç Search resident or INN...' } }
        }).render(document.getElementById("grid-mount"));
    }

    document.getElementById('downloadBtn').addEventListener('click', async () => {
        const outWb = new ExcelJS.Workbook();
        const outSheet = outWb.addWorksheet('Baza_2022_2025');

        // Build 4-Row Header
        const r1 = ["‚Ññ", "–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Ä–µ–∑–∏–¥–µ–Ω—Ç–∞", "–†–µ–≥–∏–æ–Ω–∞–ª—å–Ω—ã–π –æ—Ñ–∏—Å", "–î–æ—Ö–æ–¥ –æ—Ç —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —É—Å–ª—É–≥", "", "", "–î–æ—Ö–æ–¥ –æ—Ç —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —ç–∫—Å–ø–æ—Ä—Ç (USD)", "", "", "", "", "–î–æ—Ö–æ–¥—ã –≥–æ—Å. —Å–µ–∫—Ç–æ—Ä", "", "", "–î—Ä—É–≥–∏–µ –¥–æ—Ö–æ–¥—ã", "", "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–∞–±–æ—Ç–Ω–∏–∫–∞—Ö"];
        const r2 = ["", "", "", "–£—Å–ª—É–≥–∏", "–°—É–º–º–∞", "–û–ö–≠–î", "–£—Å–ª—É–≥–∏", "–°—Ç—Ä–∞–Ω–∞", "USD", "–°—É–º–º–∞ —Å—É–º", "–û–ö–≠–î", "–ì–æ—Å–æ—Ä–≥–∞–Ω", "–ü—Ä–æ–µ–∫—Ç", "–°—É–º–º–∞", "–ü–æ–∫–∞–∑–∞—Ç–µ–ª—å", "–°—É–º–º–∞", "–ê–¥–º–∏–Ω", "", "–ò–Ω–æ—Å—Ç—Ä–∞–Ω—Ü—ã", "", "–û—Å–Ω–æ–≤–Ω–æ–π", "", "–ò–Ω–æ—Å—Ç—Ä–∞–Ω—Ü—ã", "", "–ì–ü–•", "", "–ü—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç—ã", "", "–ò–Ω–æ—Å—Ç—Ä–∞–Ω—Ü—ã", "", "–ì–ü–•", "", "–ò–Ω—Ñ–æ-—É—Å–ª—É–≥–∏", "", "–ò–Ω–æ—Å—Ç—Ä–∞–Ω—Ü—ã", "", "–ì–ü–•", "", "–£—á–∏—Ç–µ–ª—è", "", "–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã", "", "–ò–Ω–æ—Å—Ç—Ä–∞–Ω—Ü—ã", "", "–ì–ü–•", "", "–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏", "–°–æ–±—Å—Ç–≤.", "–ü—Ä–æ—á–∏–µ", "–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞", "–°—Ç–∞—Ä—Ç–∞–ø—ã", "–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ", "–û–±—É—á–µ–Ω–∏–µ", "–ó–∞–∫–∞–∑—ã", "–ü–û"];
        const r3 = Array(16).fill(""); for(let i=0; i<15; i++) r3.push("–ö–æ–ª-–≤–æ", "–ó–ü");
        
        outSheet.addRow(r1); outSheet.addRow(r2); outSheet.addRow(r3); outSheet.addRow(headers);
        
        // Merges
        outSheet.mergeCells('A1:A3'); outSheet.mergeCells('B1:B3'); outSheet.mergeCells('C1:C3');
        outSheet.mergeCells('D1:F1'); outSheet.mergeCells('G1:K1'); outSheet.mergeCells('L1:N1');
        outSheet.mergeCells('O1:P1'); outSheet.mergeCells('Q1:AT1'); outSheet.mergeCells('AU1:BC1');

        rawData.forEach(d => outSheet.addRow(d));

        // Styling: Calibri 10 + Orange Row 4
        outSheet.eachRow((row, rowNum) => {
            row.eachCell({ includeEmpty: true }, (cell) => {
                cell.font = { name: 'Calibri', size: 10, bold: rowNum <= 4 };
                cell.border = { top: {style:'thin'}, left: {style:'thin'}, bottom: {style:'thin'}, right: {style:'thin'} };
                
                if (rowNum === 4) {
                    cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFCD5B4' } };
                } else if (rowNum < 4) {
                    cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFF2F2F2' } };
                }
                cell.alignment = { vertical: 'middle', horizontal: 'left', wrapText: false };
            });
        });

        const buffer = await outWb.xlsx.writeBuffer();
        const a = document.createElement('a');
        a.href = URL.createObjectURL(new Blob([buffer]));
        a.download = `Formatted_Baza_${Date.now()}.xlsx`;
        a.click();
    });
</script>

</body>
</html>