<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excel Transformer - Custom Row Color</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f0f2f5; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        .card { background: white; padding: 2.5rem; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); width: 100%; max-width: 500px; text-align: center; }
        h2 { color: #202124; margin-bottom: 1.5rem; font-weight: 600; }
        .upload-area { border: 2px dashed #4285f4; padding: 2rem; border-radius: 10px; margin-bottom: 1.5rem; cursor: pointer; background: #f8fbff; display: block; }
        .upload-area:hover { background: #eef4ff; }
        #fileLabel { color: #4285f4; font-weight: 500; }
        .btn { background: #34a853; color: white; border: none; padding: 14px 28px; border-radius: 6px; font-weight: bold; cursor: pointer; width: 100%; font-size: 1rem; }
        .btn:disabled { background: #bdc3c7; cursor: not-allowed; }
        #status { margin-top: 1rem; font-size: 0.9rem; color: #1a73e8; font-weight: 500; }
    </style>
</head>
<body>

<div class="card">
    <h2>Excel Formatter</h2>
    <label for="fileInput" class="upload-area">
        <div id="fileLabel">Click to upload Statistics file</div>
        <input type="file" id="fileInput" accept=".xlsx, .csv" style="display:none">
    </label>
    <button id="processBtn" class="btn" disabled>Generate & Download</button>
    <div id="status"></div>
</div>

<script>
    const fileInput = document.getElementById('fileInput');
    const processBtn = document.getElementById('processBtn');
    const status = document.getElementById('status');
    const fileLabel = document.getElementById('fileLabel');

    fileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
            fileLabel.innerText = "File: " + e.target.files[0].name;
            processBtn.disabled = false;
        }
    });

    processBtn.addEventListener('click', async () => {
        const file = fileInput.files[0];
        status.innerText = "Applying Calibri 10 and RGB background...";

        const reader = new FileReader();
        reader.onload = async (e) => {
            const buffer = e.target.result;
            const workbook = new ExcelJS.Workbook();
            
            try {
                if (file.name.endsWith('.csv')) {
                    await workbook.csv.readBinaryValue(buffer);
                } else {
                    await workbook.xlsx.load(buffer);
                }

                const sourceSheet = workbook.worksheets[0];
                const outWb = new ExcelJS.Workbook();
                const outSheet = outWb.addWorksheet('Baza_2022_2025');

                // --- HEADER DATA ---
                const row1 = ["№", "Наименование резидента", "Региональный офис", "Доход от реализации услуг", "", "", "Доход от реализации услуг от экспортных операций (доллары США)", "", "", "", "", "Доходы от проектов реализованных в государственном секторе", "", "", "Другие виды доходов", "", "Информация о работниках резидента"];
                const row2 = ["", "", "", "Наименование услуг", "Сумма (тыс. сум)", "ОКЭД", "Наименование услуг", "Страна", "USD", "Сумма (тыс. сум)", "ОКЭД", "Госорган", "Проект", "Сумма (тыс. сум)", "Показатель", "Сумма (тыс. сум)", "Административный персонал", "", "иностранных граждан", "", "Основной персонал", "", "иностранных граждан", "", "ГПХ договор", "", "Программисты", "", "иностранных граждан", "", "ГПХ договор", "", "Информационные услуги", "", "иностранных граждан", "", "ГПХ договор", "", "Учителя", "", "Межд. сертификаты", "", "иностранных граждан", "", "ГПХ договор", "", "Источники инвестиций", "Собственные", "Прочие", "Инвестиции направленные на", "Стартапы", "Недвижимость", "Повышение квалификации", "Привлечение заказов", "Разработка ПО"];
                const row3 = Array(16).fill("");
                for(let i=0; i<15; i++) row3.push("Количество", "Заработная плата");
                
                const row4Labels = ["№", "Rez_NAME", "Reg_office", "1.1 Uslugi_name", "1.2 Summa_tis.sum", "1.3 OKED", "1.4 Uslugi_name", "2.1 Strana_exp", "2.2 Exp_doll", "2.3 Exp_tis.sum", "2.4 OKED", "3.1 Name_Gov", "3.2 Project_name", "3.3 Summa_tis.sum", "4.1 Other", "4.2 Other_tis.sum", "5.1 admin_count", "5.2 admin_salary", "6.1 admin_foreign_count", "6.2 admin_foreign_salary", "7.1 core_count", "7.2 core_salary", "8.1 core_foreign_count", "8.2 core_foreign_salary", "9.1 core_contract_count", "9.2 core_contract_salary", "10.1 dev_count", "10.2 dev_salary", "11.1 dev_foreign_count", "11.2 dev_foreign_salary", "12.1 dev_contract_count", "12.2 dev_contract_salary", "13.1 info_count", "13.2 info_salary", "14.1 info_foreign_count", "14.2 info_foreign_salary", "15.1 info_contract_count", "15.2 info_contract_salary", "16.1 teachers_count", "16.2 teachers_salary", "17.1 cert_teachers_count", "17.2 cert_teachers_salary", "18.1 teachers_foreign_count", "18.2 teachers_foreign_salary", "19.1 teachers_contract_count", "19.2 teachers_contract_salary", "20.1 inv", "20.2 inv_own_funds", "20.3 inv_other_sources", "21.1 Inv_direc", "21.2 inv_direc_startups", "21.3 inv_property_equipment", "21.4 inv_training_it", "21.5 inv_foreign_clients", "21.6 inv_new_software"];

                outSheet.addRow(row1);
                outSheet.addRow(row2);
                outSheet.addRow(row3);
                outSheet.addRow(row4Labels);

                outSheet.mergeCells('A1:A3'); outSheet.mergeCells('B1:B3'); outSheet.mergeCells('C1:C3');
                outSheet.mergeCells('D1:F1'); outSheet.mergeCells('G1:K1'); outSheet.mergeCells('L1:N1');
                outSheet.mergeCells('O1:P1'); outSheet.mergeCells('Q1:AT1'); outSheet.mergeCells('AU1:BC1');

                // --- DATA MAPPING ---
                sourceSheet.eachRow((row, rowNum) => {
                    if (rowNum <= 4) return;
                    const rowData = [];
                    for(let i=1; i<=55; i++) rowData.push(row.getCell(i).value);
                    outSheet.addRow(rowData);
                });

                // --- GLOBAL STYLING (Calibri 10 + Custom Color) ---
                outSheet.eachRow((row, rowNum) => {
                    row.eachCell({ includeEmpty: true }, (cell) => {
                        // Global font style
                        cell.font = { name: 'Calibri', size: 10, bold: rowNum <= 4 };
                        cell.border = {
                            top: {style:'thin'}, left: {style:'thin'}, 
                            bottom: {style:'thin'}, right: {style:'thin'}
                        };

                        if (rowNum === 4) {
                            // Apply background RGB(252, 213, 180) to Row 4
                            cell.fill = {
                                type: 'pattern',
                                pattern: 'solid',
                                fgColor: { argb: 'FFFCD5B4' } // Hex equivalent of your RGB
                            };
                        } else if (rowNum < 4) {
                            cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFF2F2F2' } };
                        }

                        cell.alignment = { vertical: 'middle', horizontal: (rowNum <= 4 ? 'center' : 'left'), wrapText: true };
                    });
                });

                outSheet.columns.forEach(col => col.width = 18);

                const bufferOut = await outWb.xlsx.writeBuffer();
                const blob = new Blob([bufferOut], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = 'Baza_Styled.xlsx';
                a.click();
                status.innerText = "Success! File generated.";

            } catch (err) {
                console.error(err);
                status.innerText = "Error processing file.";
            }
        };
        reader.readAsArrayBuffer(file);
    });
</script>
</body>
</html>